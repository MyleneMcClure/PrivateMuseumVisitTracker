<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Museum Visit Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 800px;
            width: 90%;
            margin: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #1e3c72, #2a5298, #7e22ce);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 20px;
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .feature-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border-left: 4px solid #2a5298;
            transition: transform 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-5px);
        }

        .feature-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .feature-card p {
            color: #666;
            line-height: 1.6;
        }

        .actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .btn {
            background: linear-gradient(135deg, #2a5298, #7e22ce);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            text-align: center;
            display: inline-block;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(42, 82, 152, 0.4);
        }

        .btn.secondary {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .status {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .status.error {
            background: #ffe8e8;
            border-color: #f44336;
        }

        .status.warning {
            background: #fff3cd;
            border-color: #ffc107;
        }

        .privacy-notice {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .privacy-notice h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .privacy-notice p {
            color: #555;
            line-height: 1.6;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2a5298;
        }

        .hidden {
            display: none;
        }

        #wallet-info {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: #f0f8ff;
            border-radius: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #2a5298, #7e22ce);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .network-info {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }

        .contract-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèõÔ∏è Private Museum Visit Tracker</h1>
            <p>Confidential Cultural Consumption Data System powered by Zama FHE Technology</p>
        </div>

        <div class="privacy-notice">
            <h4>üîê Privacy Protection Guarantee</h4>
            <p>This system uses Fully Homomorphic Encryption (FHE) technology to ensure complete privacy of your personal information and visit data. All sensitive data is stored in encrypted form on the blockchain and cannot be decrypted by any third party.</p>
        </div>

        <div class="privacy-notice" style="background: #fff3cd; border-left: 4px solid #ffc107;">
            <h4 style="color: #856404;">‚ö†Ô∏è Important: Registration Required</h4>
            <p style="color: #856404;"><strong>First-time users must register as a visitor before recording any visits.</strong> Click "Register Visitor" button and enter your age to get started. Your age will be encrypted for privacy protection.</p>
        </div>

        <div class="features">
            <div class="feature-card">
                <h3>üîí Complete Privacy Protection</h3>
                <p>Age, satisfaction, interest level and other sensitive information are fully encrypted to protect visitor privacy</p>
            </div>
            <div class="feature-card">
                <h3>üìä Smart Statistical Analysis</h3>
                <p>Provides valuable visitor behavior analysis for museums while protecting privacy</p>
            </div>
            <div class="feature-card">
                <h3>üé® Multi-type Exhibition Support</h3>
                <p>Supports History, Art, Science, Culture, Technology, Nature and other exhibition types</p>
            </div>
            <div class="feature-card">
                <h3>‚õìÔ∏è Blockchain Certification</h3>
                <p>All data stored on blockchain ensures data immutability and transparency</p>
            </div>
        </div>

        <div class="network-info">
            <p><strong>üåê Supported Network:</strong> Sepolia Testnet (Zama FHE-enabled)</p>
            <p><strong>‚ö° Required:</strong> MetaMask wallet connected to Sepolia network</p>
        </div>

        <div class="contract-info">
            <p><strong>üìã Smart Contract:</strong></p>
            <p>Name: PrivateMuseumVisitTracker</p>
            <p>Network: Sepolia Testnet</p>
            <p>Address: <span id="contract-address-display">Deploy contract to see address</span></p>
        </div>

        <div id="wallet-info" class="hidden">
            <p>Wallet Address: <span id="wallet-address"></span></p>
            <p>Connection Status: <span id="connection-status">Not Connected</span></p>
            <p>Network: <span id="network-name">Unknown</span></p>
        </div>

        <div class="actions">
            <button class="btn" onclick="connectWallet()">Connect Wallet</button>
            <button class="btn secondary" onclick="showRegisterForm()">Register Visitor</button>
            <button class="btn" onclick="showVisitForm()">Record Visit</button>
            <button class="btn secondary" onclick="showExhibitionForm()">Create Exhibition</button>
            <button class="btn" onclick="showStats()">View Statistics</button>
        </div>

        <!-- Visitor Registration Form -->
        <div id="register-form" class="hidden">
            <h3>Visitor Registration</h3>
            <div class="form-group">
                <label for="age">Age (will be encrypted for privacy)</label>
                <input type="number" id="age" min="1" max="120" placeholder="Enter your age">
            </div>
            <button class="btn" onclick="registerVisitor()">Register Visitor</button>
            <button class="btn secondary" onclick="hideForm('register-form')">Cancel</button>
        </div>

        <!-- Visit Recording Form -->
        <div id="visit-form" class="hidden">
            <h3>Record Visit Experience</h3>
            <div class="form-group">
                <label for="exhibition-id">Exhibition ID</label>
                <input type="number" id="exhibition-id" placeholder="Enter exhibition ID">
            </div>
            <div class="form-group">
                <label for="satisfaction">Satisfaction (1-10, will be encrypted)</label>
                <input type="number" id="satisfaction" min="1" max="10" placeholder="Rate 1-10">
            </div>
            <div class="form-group">
                <label for="duration">Visit Duration (minutes)</label>
                <input type="number" id="duration" placeholder="Duration in minutes">
            </div>
            <div class="form-group">
                <label for="interest">Interest Level (1-5, will be encrypted)</label>
                <input type="number" id="interest" min="1" max="5" placeholder="Rate 1-5">
            </div>
            <button class="btn" onclick="recordVisit()">Submit Record</button>
            <button class="btn secondary" onclick="hideForm('visit-form')">Cancel</button>
        </div>

        <!-- Exhibition Creation Form -->
        <div id="exhibition-form" class="hidden">
            <h3>Create New Exhibition</h3>
            <div class="form-group">
                <label for="exhibition-name">Exhibition Name</label>
                <input type="text" id="exhibition-name" placeholder="Enter exhibition name">
            </div>
            <div class="form-group">
                <label for="exhibition-type">Exhibition Type</label>
                <select id="exhibition-type">
                    <option value="0">History</option>
                    <option value="1">Art</option>
                    <option value="2">Science</option>
                    <option value="3">Culture</option>
                    <option value="4">Technology</option>
                    <option value="5">Nature</option>
                </select>
            </div>
            <div class="form-group">
                <label for="start-date">Start Date (Unix timestamp)</label>
                <input type="number" id="start-date" placeholder="Start date timestamp">
            </div>
            <div class="form-group">
                <label for="end-date">End Date (Unix timestamp)</label>
                <input type="number" id="end-date" placeholder="End date timestamp">
            </div>
            <button class="btn" onclick="createExhibition()">Create Exhibition</button>
            <button class="btn secondary" onclick="hideForm('exhibition-form')">Cancel</button>
        </div>

        <!-- Statistics Display -->
        <div id="stats-display" class="hidden">
            <h3>System Statistics</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-exhibitions">-</div>
                    <div class="stat-label">Total Exhibitions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-visitors">-</div>
                    <div class="stat-label">Registered Visitors</div>
                </div>
            </div>
            <button class="btn secondary" onclick="hideForm('stats-display')">Close</button>
        </div>

        <div id="status-message" class="status hidden">
            <p id="status-text"></p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>
    <script>
        let provider;
        let signer;
        let contract;
        let userAccount;

        // Contract ABI for PrivateMuseumVisitTracker
        const contractABI = [
            {
                "inputs": [],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "inputs": [{"internalType": "uint8", "name": "_age", "type": "uint8"}],
                "name": "registerVisitor",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "uint32", "name": "_exhibitionId", "type": "uint32"},
                    {"internalType": "uint8", "name": "_satisfaction", "type": "uint8"},
                    {"internalType": "uint32", "name": "_duration", "type": "uint32"},
                    {"internalType": "uint8", "name": "_interestLevel", "type": "uint8"}
                ],
                "name": "recordPrivateVisit",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "string", "name": "_name", "type": "string"},
                    {"internalType": "uint8", "name": "_type", "type": "uint8"},
                    {"internalType": "uint32", "name": "_startDate", "type": "uint32"},
                    {"internalType": "uint32", "name": "_endDate", "type": "uint32"}
                ],
                "name": "createExhibition",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getPublicStats",
                "outputs": [
                    {"internalType": "uint32", "name": "totalExhibitionsCount", "type": "uint32"},
                    {"internalType": "uint32", "name": "totalRegisteredVisitorsCount", "type": "uint32"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint32", "name": "_exhibitionId", "type": "uint32"}],
                "name": "getExhibitionInfo",
                "outputs": [
                    {"internalType": "string", "name": "name", "type": "string"},
                    {"internalType": "uint8", "name": "exhibitionType", "type": "uint8"},
                    {"internalType": "uint32", "name": "startDate", "type": "uint32"},
                    {"internalType": "uint32", "name": "endDate", "type": "uint32"},
                    {"internalType": "bool", "name": "isActive", "type": "bool"},
                    {"internalType": "uint32", "name": "publicVisitorCount", "type": "uint32"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getMyStats",
                "outputs": [
                    {"internalType": "bool", "name": "isRegistered", "type": "bool"},
                    {"internalType": "uint32", "name": "registrationDate", "type": "uint32"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true, "internalType": "uint32", "name": "exhibitionId", "type": "uint32"},
                    {"indexed": false, "internalType": "string", "name": "name", "type": "string"},
                    {"indexed": false, "internalType": "uint8", "name": "exhibitionType", "type": "uint8"}
                ],
                "name": "ExhibitionCreated",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true, "internalType": "address", "name": "visitor", "type": "address"},
                    {"indexed": false, "internalType": "uint32", "name": "timestamp", "type": "uint32"}
                ],
                "name": "VisitorRegistered",
                "type": "event"
            }
        ];

        // Contract address - Update this after deployment
        const contractAddress = "0xe4432488D78fd8CF32b096c385Ca251230427458"; // Deployed contract address

        // Sepolia testnet configuration
        const sepoliaChainId = '0xaa36a7'; // 11155111 in hex
        const sepoliaRPC = 'https://sepolia.infura.io/v3/9aa3d95b3bc440fa88ea12eaa4456161';

        async function connectWallet() {
            try {
                if (typeof window.ethereum !== 'undefined') {
                    // Request account access
                    await window.ethereum.request({ method: 'eth_requestAccounts' });

                    provider = new ethers.BrowserProvider(window.ethereum);
                    signer = await provider.getSigner();
                    userAccount = await signer.getAddress();

                    // Check if connected to Sepolia
                    const network = await provider.getNetwork();
                    const chainId = '0x' + network.chainId.toString(16);

                    if (chainId !== sepoliaChainId) {
                        await switchToSepolia();
                    }

                    document.getElementById('wallet-address').textContent = userAccount.substring(0,6) + '...' + userAccount.substring(38);
                    document.getElementById('connection-status').textContent = 'Connected';
                    document.getElementById('network-name').textContent = network.name;
                    document.getElementById('wallet-info').classList.remove('hidden');

                    // Initialize contract if address is set
                    if (contractAddress !== "0x0000000000000000000000000000000000000000") {
                        contract = new ethers.Contract(contractAddress, contractABI, signer);
                        document.getElementById('contract-address-display').textContent = contractAddress;
                    }

                    showStatus('Wallet connected successfully!', 'success');
                } else {
                    showStatus('Please install MetaMask wallet', 'error');
                }
            } catch (error) {
                showStatus('Wallet connection failed: ' + error.message, 'error');
            }
        }

        async function switchToSepolia() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: sepoliaChainId }],
                });
            } catch (switchError) {
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: sepoliaChainId,
                                chainName: 'Sepolia Test Network',
                                nativeCurrency: {
                                    name: 'SepoliaETH',
                                    symbol: 'ETH',
                                    decimals: 18
                                },
                                rpcUrls: [sepoliaRPC],
                                blockExplorerUrls: ['https://sepolia.etherscan.io/']
                            }]
                        });
                    } catch (addError) {
                        throw new Error('Failed to add Sepolia network');
                    }
                } else {
                    throw new Error('Failed to switch to Sepolia network');
                }
            }
        }

        async function registerVisitor() {
            if (!contract) {
                showStatus('Please connect wallet and ensure contract is deployed', 'error');
                return;
            }

            const age = document.getElementById('age').value;
            if (!age || age < 1 || age > 120) {
                showStatus('Please enter valid age (1-120)', 'error');
                return;
            }

            try {
                showStatus('Registering visitor...', 'warning');
                const tx = await contract.registerVisitor(age);
                await tx.wait();
                showStatus('Visitor registration successful! Your age information is encrypted and protected.', 'success');
                hideForm('register-form');
                document.getElementById('age').value = '';
            } catch (error) {
                showStatus('Registration failed: ' + error.message, 'error');
            }
        }

        async function recordVisit() {
            if (!contract) {
                showStatus('Please connect wallet and ensure contract is deployed', 'error');
                return;
            }

            const exhibitionId = document.getElementById('exhibition-id').value;
            const satisfaction = document.getElementById('satisfaction').value;
            const duration = document.getElementById('duration').value;
            const interest = document.getElementById('interest').value;

            if (!exhibitionId || !satisfaction || !duration || !interest) {
                showStatus('Please fill all fields', 'error');
                return;
            }

            if (satisfaction < 1 || satisfaction > 10 || interest < 1 || interest > 5) {
                showStatus('Satisfaction range 1-10, Interest range 1-5', 'error');
                return;
            }

            try {
                showStatus('Recording visit information...', 'warning');
                const tx = await contract.recordPrivateVisit(
                    exhibitionId,
                    satisfaction,
                    duration,
                    interest
                );
                await tx.wait();
                showStatus('Visit recorded successfully! Your experience data is encrypted and protected.', 'success');
                hideForm('visit-form');
                clearVisitForm();
            } catch (error) {
                showStatus('Recording failed: ' + error.message, 'error');
            }
        }

        async function createExhibition() {
            if (!contract) {
                showStatus('Please connect wallet and ensure contract is deployed', 'error');
                return;
            }

            const name = document.getElementById('exhibition-name').value;
            const type = document.getElementById('exhibition-type').value;
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            if (!name || !startDate || !endDate) {
                showStatus('Please fill all fields', 'error');
                return;
            }

            if (parseInt(endDate) <= parseInt(startDate)) {
                showStatus('End date must be after start date', 'error');
                return;
            }

            try {
                showStatus('Creating exhibition...', 'warning');
                const tx = await contract.createExhibition(name, type, startDate, endDate);
                await tx.wait();
                showStatus('Exhibition created successfully!', 'success');
                hideForm('exhibition-form');
                clearExhibitionForm();
            } catch (error) {
                showStatus('Exhibition creation failed: ' + error.message, 'error');
            }
        }

        async function showStats() {
            if (!contract) {
                showStatus('Please connect wallet and ensure contract is deployed', 'error');
                return;
            }

            try {
                const stats = await contract.getPublicStats();
                document.getElementById('total-exhibitions').textContent = stats.totalExhibitionsCount.toString();
                document.getElementById('total-visitors').textContent = stats.totalRegisteredVisitorsCount.toString();
                document.getElementById('stats-display').classList.remove('hidden');
            } catch (error) {
                showStatus('Failed to get statistics: ' + error.message, 'error');
            }
        }

        function showRegisterForm() {
            hideAllForms();
            document.getElementById('register-form').classList.remove('hidden');
        }

        function showVisitForm() {
            hideAllForms();
            document.getElementById('visit-form').classList.remove('hidden');
        }

        function showExhibitionForm() {
            hideAllForms();
            document.getElementById('exhibition-form').classList.remove('hidden');
        }

        function hideForm(formId) {
            document.getElementById(formId).classList.add('hidden');
        }

        function hideAllForms() {
            const forms = ['register-form', 'visit-form', 'exhibition-form', 'stats-display'];
            forms.forEach(formId => hideForm(formId));
        }

        function clearVisitForm() {
            document.getElementById('exhibition-id').value = '';
            document.getElementById('satisfaction').value = '';
            document.getElementById('duration').value = '';
            document.getElementById('interest').value = '';
        }

        function clearExhibitionForm() {
            document.getElementById('exhibition-name').value = '';
            document.getElementById('exhibition-type').value = '0';
            document.getElementById('start-date').value = '';
            document.getElementById('end-date').value = '';
        }

        function showStatus(message, type = 'success') {
            const statusDiv = document.getElementById('status-message');
            const statusText = document.getElementById('status-text');

            statusText.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.classList.remove('hidden');

            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 5000);
        }

        // Page load initialization
        window.addEventListener('load', () => {
            if (contractAddress === "0x0000000000000000000000000000000000000000") {
                showStatus('Smart contract not yet deployed. Please deploy the contract and update the address.', 'warning');
            }
        });

        // Handle account changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    showStatus('Wallet disconnected', 'warning');
                    document.getElementById('wallet-info').classList.add('hidden');
                } else {
                    connectWallet();
                }
            });

            window.ethereum.on('chainChanged', (chainId) => {
                window.location.reload();
            });
        }
    </script>
</body>
</html>